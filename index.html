<script>

/* ===================================== */
/* Konfigurierbare Spalten-Positionen   */
/* ===================================== */

const COL_DATE = 0;
const COL_ORT  = 1;
const COL_NAME_START = 6;

let table;
let lastCsvSignature = null;

/* Datum korrekt sortieren */
function parseDate(dateStr) {
  const parts = dateStr.split(".");
  return new Date(parts[2], parts[1] - 1, parts[0]);
}

/* Wochenende erkennen */
function isWeekend(dateStr) {
  const d = parseDate(dateStr);
  const day = d.getDay();
  return day === 0 || day === 6;
}

/* Ortsfilter */
function filterOrt(value) {
  table.column(COL_ORT).search(value).draw();
}

/* CSV laden & ggf. Tabelle aktualisieren */
function loadCsv(initialLoad = false) {

  const csvUrl = "https://dariolorenzon.github.io/Teneriffa/golfplan.csv?v=" + Date.now();

  Papa.parse(csvUrl, {
    download: true,
    delimiter: ";",
    skipEmptyLines: true,

    complete: function(results) {

      const rows = results.data;
      const headers = rows[0];
      const data = rows.slice(1);

      const newSignature = JSON.stringify(rows);

      /* Wenn keine Änderung → nichts tun */
      if (!initialLoad && newSignature === lastCsvSignature) {
        return;
      }

      lastCsvSignature = newSignature;

      /* Zeit aktualisieren */
      const now = new Date();
      document.getElementById("lastUpdate").textContent =
        "Letzte Aktualisierung: " +
        now.toLocaleDateString("de-CH") + " " +
        now.toLocaleTimeString("de-CH");

      if (initialLoad) {

        /* Header erzeugen */
        const theadRow =
          '<tr>' +
          headers.map((h, index) => {

            if (h.startsWith("Tee Time")) {
              const number = h.replace("Tee Time", "").trim();
              return `<th>Tee<br>Time ${number}</th>`;
            }

            if (index >= COL_NAME_START) {
              const parts = h.split(" ");
              if (parts.length >= 2) {
                return `<th>${parts[0]}<br>${parts[1]}</th>`;
              }
            }

            return `<th>${h}</th>`;

          }).join('') +
          '</tr>';

        document.querySelector('#golfTable thead').innerHTML = theadRow;

        /* DataTable initialisieren */
        table = $('#golfTable').DataTable({

          dom: 'Blrtip',
          searching: true,

          buttons: [{
            extend: 'colvis',
            text: 'Spalten anzeigen'
          }],

          data: data,

          scrollX: true,
          scrollY: "70vh",
          scrollCollapse: true,

          pageLength: 50,
          order: [[COL_DATE, "asc"]],

          fixedColumns: { leftColumns: 2 },
          fixedHeader: true,

          columnDefs: [

            {
              targets: COL_DATE,
              render: function(data, type) {
                if (type === "sort") {
                  return parseDate(data).getTime();
                }
                return data;
              }
            },

            {
              targets: "_all",
              className: "dt-center"
            },

            {
              targets: function(index) {
                return index >= COL_NAME_START;
              },
              render: function(data, type) {
                if (type === "display" && data) {
                  const parts = data.split(" ");
                  if (parts.length >= 2) {
                    return parts[0] + "<br>" + parts[1];
                  }
                }
                return data;
              }
            }
          ],

          createdRow: function(row, rowData) {
            if (isWeekend(rowData[COL_DATE])) {
              $(row).addClass("weekend");
            }
          }

        });

      } else {

        /* Nur Daten aktualisieren – kein Reload */
        table.clear();
        table.rows.add(data);
        table.draw(false);
      }

    }
  });
}

/* Initial laden */
document.addEventListener("DOMContentLoaded", function () {

  loadCsv(true);

/* ===================================== */
/* Nur neu laden wenn CSV geändert wurde */
/* ===================================== */

let lastCsvSnapshot = null;

function checkForCsvUpdate() {

  fetch("https://dariolorenzon.github.io/Teneriffa/golfplan.csv")
    .then(response => response.text())
    .then(text => {

      if (lastCsvSnapshot === null) {
        // Erstes Laden – Snapshot speichern
        lastCsvSnapshot = text;
        return;
      }

      if (text !== lastCsvSnapshot) {
        console.log("CSV geändert – Seite wird neu geladen");
        location.reload();
      }

    })
    .catch(error => {
      console.warn("CSV-Check fehlgeschlagen:", error);
    });
}

// Alle 30 Minuten prüfen
setInterval(checkForCsvUpdate, 30 * 60 * 1000);
  

});

</script>

